From a48d2b48f11b759a9eda7d3cac1a215cabd07684 Mon Sep 17 00:00:00 2001
From: Silvio Traversaro <silvio.traversaro@iit.it>
Date: Sat, 27 Aug 2022 12:03:47 +0200
Subject: [PATCH] Update CMakeLists.txt

---
 bindings/python/CMakeLists.txt | 19 +++++++++++++++----
 1 file changed, 15 insertions(+), 4 deletions(-)

diff --git a/bindings/python/CMakeLists.txt b/bindings/python/CMakeLists.txt
index eb110f5eb0f..d8b90b04462 100644
--- a/bindings/python/CMakeLists.txt
+++ b/bindings/python/CMakeLists.txt
@@ -23,6 +23,21 @@ set_property(
     TARGET ${target_name}
     PROPERTY SWIG_DEPENDS python.i numpy.i)
 
+if(WIN32)
+    set_target_properties(${target_name} PROPERTIES SUFFIX ".pyd")
+endif(WIN32)
+
+# Fix for PyPy
+# See https://gitlab.kitware.com/cmake/cmake/-/issues/23651
+# See https://github.com/conda-forge/idyntree-feedstock/pull/44
+if(Python3_INTERPRETER_ID STREQUAL "PyPy")
+    execute_process(COMMAND ${Python3_EXECUTABLE}
+                    -c "import sysconfig; print(sysconfig.get_config_var('EXT_SUFFIX'))"
+                    OUTPUT_VARIABLE IDYNTREE_PYTHON_EXT_SUFFIX)
+    string(STRIP ${IDYNTREE_PYTHON_EXT_SUFFIX} IDYNTREE_PYTHON_EXT_SUFFIX)
+    set_property (TARGET ${target_name} PROPERTY SUFFIX "${IDYNTREE_PYTHON_EXT_SUFFIX}")
+endif()
+
 if(NOT MSVC)
     set_property(
         TARGET ${target_name}
@@ -48,10 +63,6 @@ install(
     DESTINATION ${PYTHON_INSTDIR}
     COMPONENT python)
 
-if(WIN32)
-    set_target_properties(${target_name} PROPERTIES SUFFIX ".pyd")
-endif(WIN32)
-
 add_subdirectory(scripts)
 
 # if compile tests execute also python tests
 
